WITH base AS (
  SELECT p.sequence_number, c.display_name as category, p.name, p.value,
         p.description, p.datasheet, p.keywords, p.fields,
         p.created_at, p.updated_at
  FROM parts p
  JOIN categories c ON c.id = p.category_id
  WHERE ( {{ SelectCategory.selectedOptionValue ? 'p.category_id = ' + SelectCategory.selectedOptionValue : '1=1' }} )
    AND p.is_active = TRUE
)
SELECT *
FROM base
ORDER BY
  CASE WHEN {{TableParts.sortOrder?.column === 'name'       }} THEN name       END {{ TableParts.sortOrder?.order || 'ASC' }},
  CASE WHEN {{TableParts.sortOrder?.column === 'value'      }} THEN value      END {{ TableParts.sortOrder?.order || 'ASC' }},
  CASE WHEN {{TableParts.sortOrder?.column === 'updated_at' }} THEN updated_at END {{ TableParts.sortOrder?.order || 'DESC' }},
  sequence_number ASC
LIMIT {{ TableParts.pageSize }}
OFFSET {{ (TableParts.pageNo - 1) * TableParts.pageSize }};
